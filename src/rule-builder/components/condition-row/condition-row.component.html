<div class="flex items-center gap-3 p-3 rounded-lg bg-white shadow-sm border border-gray-200 w-full">
  <!-- Field Selector -->
  <select
    [ngModel]="condition().fieldId"
    (ngModelChange)="onFieldChange($event)"
    class="w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
  >
    <option [ngValue]="null" disabled>Select Field</option>
    @for(field of fields(); track field.id) {
      <option [value]="field.id">{{ field.name }}</option>
    }
  </select>
  
  @if (selectedField()) {
    <!-- Operator Selector -->
    <select
      [ngModel]="condition().operator"
      (ngModelChange)="onOperatorChange($event)"
      class="w-1/4 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
    >
      @for(op of selectedField()!.operators; track op) {
        <option [value]="op">{{ operatorNameMapping[op] }}</option>
      }
    </select>

    <!-- Value Input -->
    @if (isValueRequired()) {
      <div class="w-1/3">
        @switch (selectedField()?.type) {
          @case ('text') {
            <input
              type="text"
              class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              [class.border-gray-300]="!showError()"
              [class.border-red-500]="showError()"
              [ngModel]="condition().value"
              (ngModelChange)="onValueChange($event)"
              placeholder="Value"
            />
          }
          @case ('number') {
            <input
              type="number"
              class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              [class.border-gray-300]="!showError()"
              [class.border-red-500]="showError()"
              [ngModel]="condition().value"
              (ngModelChange)="onValueChange($event)"
              placeholder="Value"
            />
          }
          @case ('date') {
            <input
              type="date"
              class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              [class.border-gray-300]="!showError()"
              [class.border-red-500]="showError()"
              [ngModel]="condition().value"
              (ngModelChange)="onValueChange($event)"
            />
          }
           @case ('boolean') {
            <select
              class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              [class.border-gray-300]="!showError()"
              [class.border-red-500]="showError()"
              [ngModel]="condition().value"
              (ngModelChange)="onValueChange($event)"
            >
              <option [ngValue]="null" disabled>Select boolean</option>
              <option [ngValue]="true">True</option>
              <option [ngValue]="false">False</option>
            </select>
          }
          @case ('select') {
            <ng-select
              [items]="options$ | async"
              [bindLabel]="selectedField()!.source!.labelField"
              [bindValue]="selectedField()!.source!.valueField"
              [ngModel]="condition().value"
              (ngModelChange)="onValueChange($event)"
              [typeahead]="typeahead$"
              (scrollToEnd)="onScrollToEnd()"
              [loading]="loading()"
              placeholder="Select value..."
              class="w-full"
              [class.ng-select-invalid]="showError()"
            >
            </ng-select>
          }
        }
        @if(showError()) {
            <p class="mt-1 text-xs text-red-600">A value is required.</p>
        }
      </div>
    } @else {
      <div class="w-1/3"></div>
    }
  }

  <!-- Action Menu -->
  <div class="relative flex-shrink-0">
    <button
      (click)="isMenuOpen.set(!isMenuOpen())"
      (blur)="isMenuOpen.set(false)"
      class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-full hover:bg-gray-100"
      aria-label="Actions"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
      </svg>
    </button>

    @if (isMenuOpen()) {
      <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
        <div class="py-1" role="menu" aria-orientation="vertical">
          <button (mousedown)="onAddAbove()" class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
            Add condition above
          </button>
          <button (mousedown)="onAddBelow()" class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
            Add condition below
          </button>
          <div class="border-t border-gray-100 my-1"></div>
          <button (mousedown)="onRemove()" class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50" role="menuitem">
            Remove
          </button>
        </div>
      </div>
    }
  </div>
</div>
